(function() {
  Elegance.Router = (function() {
    Router.prototype.controllers = [];

    function Router(app) {
      var self;
      this.app = app;
      this.routes = [];
      this.current = null;
      this.currentURI = null;
      if (!(this.app instanceof Elegance.App)) {
        throw new Error('app must be an instance of Elegance.App!');
      }
      self = this;
      $('a').on('click', function(e) {
        var attr;
        attr = $(this).attr('href');
        if ((attr != null) === false) {

        } else if (attr.charAt(0) === "#") {

        } else if (/^https?/.test(attr)) {

        } else {
          e.preventDefault();
          return self.navigate(attr);
        }
      });
    }

    Router.prototype.setRootURL = function(rootURL) {
      this.rootURL = rootURL;
      return this.rootURL.replace(/^https?:\/\//, '');
    };

    Router.prototype.redirect = function(path1) {
      this.path = path1;
      return new Elegance.Router.Redirect(this.path);
    };

    Router.prototype.navigate = function(path, pushState) {
      var i, len, ref, route, value;
      if (pushState == null) {
        pushState = true;
      }
      console.log("navigate, raw path:'" + path + "'");
      path = path.replace(/^\/{2,}/, '').replace(/\/{2,}$/, '');
      if (path === '') {
        path = '/';
      }
      if (path === this.currentURI) {
        return false;
      }
      ref = this.routes;
      for (i = 0, len = ref.length; i < len; i++) {
        route = ref[i];
        if (route.matches(path)) {
          console.log('matches');
          if (route.target instanceof Elegance.Controller) {
            if (this.current !== null) {
              if (this.current.target instanceof Elegance.Controller) {
                if (this.current.target !== route.target) {
                  this.current.target.hide();
                }
              }
            }
            if (!route.target.initialized) {
              route.target.init();
            }
            value = route.target.show.apply(route.target, route.extractParameters(path));
            if (pushState) {
              window.history.pushState(path, path, this.rootURL + path);
            }
            this.currentURI = path;
            return this.current = route;
          }
        }
      }
      return console.log("404 Not Found (" + path + ")");
    };

    Router.prototype.map = function(callback) {
      var i, len, ref, route, target;
      callback.apply(this);
      console.log('__________routes___________');
      ref = this.routes;
      for (i = 0, len = ref.length; i < len; i++) {
        route = ref[i];
        if (route.target instanceof Elegance.Controller) {
          target = route.target.constructor.name;
        } else {
          target = null;
        }
        console.log("'" + route.path + "' -> " + route.name + " (target: " + target + ")");
      }
      return console.log('---------------------------');
    };

    Router.prototype.resource = function(name, path, target) {
      if (target == null) {
        target = null;
      }
      return this.routes.push(new Elegance.Router.Route(this.app, name, path, target));
    };

    Router.prototype.init = function() {
      var path;
      path = window.location.href.replace(this.rootURL, '');
      this.navigate(path, false);
      return $(window).bind('popstate', (function(_this) {
        return function(e) {
          path = e.originalEvent.state;
          return _this.navigate(path, false);
        };
      })(this));
    };

    return Router;

  })();

  Elegance.registerModule('router', Elegance.Router);

}).call(this);

//# sourceMappingURL=data:application/json;base64,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QU8sQ0FBQyxDQUFDLGFBQWEsQ0FBQyxLQUF2QixDQUFBO2lCQUNBLEtBQUMsQ0FBQSxRQUFELENBQVUsSUFBVixFQUFnQixLQUFoQixFQUYwQjtRQUFBLEVBQUE7TUFBQSxDQUFBLENBQUEsQ0FBQSxJQUFBLENBQTNCLEVBSks7SUFBQSxDQTlFTixDQUFBOztrQkFBQTs7TUFGRCxDQUFBOztBQUFBLEVBMEZBLFFBQVEsQ0FBQyxjQUFULENBQXdCLFFBQXhCLEVBQWtDLFFBQVEsQ0FBQyxNQUEzQyxDQTFGQSxDQUFBO0FBQUEiLCJmaWxlIjoiUm91dGVyL3JvdXRlci5qcyIsInNvdXJjZVJvb3QiOiIvc291cmNlLyIsInNvdXJjZXNDb250ZW50IjpbImNsYXNzIEVsZWdhbmNlLlJvdXRlclxyXG5cdFxyXG5cdGNvbnRyb2xsZXJzOiBbXVxyXG5cclxuXHRjb25zdHJ1Y3RvcjogKEBhcHApIC0+XHJcblx0XHRAcm91dGVzID0gW11cclxuXHRcdEBjdXJyZW50ID0gbnVsbFxyXG5cdFx0QGN1cnJlbnRVUkkgPSBudWxsXHJcblxyXG5cdFx0dW5sZXNzIEBhcHAgaW5zdGFuY2VvZiBFbGVnYW5jZS5BcHBcclxuXHRcdFx0dGhyb3cgbmV3IEVycm9yICdhcHAgbXVzdCBiZSBhbiBpbnN0YW5jZSBvZiBFbGVnYW5jZS5BcHAhJ1xyXG5cclxuXHRcdCMgbGlzdGVuIGZvciBjbGljayBldmVudHMgb24gbGlua3NcclxuXHRcdHNlbGYgPSBAXHJcblx0XHQkKCdhJykub24gJ2NsaWNrJywgKGUpIC0+XHJcblx0XHRcdGF0dHIgPSAkKHRoaXMpLmF0dHIgJ2hyZWYnXHJcblxyXG5cdFx0XHRpZiBhdHRyPyA9PSBmYWxzZVxyXG5cclxuXHRcdFx0ZWxzZSBpZiBhdHRyLmNoYXJBdCgwKSA9PSBcIiNcIlxyXG5cclxuXHRcdFx0ZWxzZSBpZiAvXmh0dHBzPy8udGVzdCBhdHRyXHJcblxyXG5cdFx0XHRlbHNlXHJcblx0XHRcdFx0ZS5wcmV2ZW50RGVmYXVsdCgpXHJcblx0XHRcdFx0c2VsZi5uYXZpZ2F0ZSBhdHRyXHJcblxyXG5cdHNldFJvb3RVUkw6IChAcm9vdFVSTCkgLT5cclxuXHRcdEByb290VVJMLnJlcGxhY2UgL15odHRwcz86XFwvXFwvLywgJydcclxuXHJcblx0cmVkaXJlY3Q6IChAcGF0aCkgLT4gbmV3IEVsZWdhbmNlLlJvdXRlci5SZWRpcmVjdCBAcGF0aFxyXG5cclxuXHRuYXZpZ2F0ZTogKHBhdGgsIHB1c2hTdGF0ZSA9IHRydWUpIC0+XHJcblx0XHRjb25zb2xlLmxvZyBcIm5hdmlnYXRlLCByYXcgcGF0aDonI3twYXRofSdcIlxyXG5cclxuXHRcdCMgc2FuaXRpemVcclxuXHRcdHBhdGggPSBwYXRoLnJlcGxhY2UoL15cXC97Mix9LywgJycpLnJlcGxhY2UoL1xcL3syLH0kLywgJycpXHJcblx0XHRwYXRoID0gJy8nIGlmIHBhdGggaXMgJydcclxuXHJcblx0XHRpZiBwYXRoID09IEBjdXJyZW50VVJJXHJcblx0XHRcdHJldHVybiBmYWxzZVxyXG5cclxuXHJcblx0XHRmb3Igcm91dGUgaW4gQHJvdXRlc1xyXG5cdFx0XHRpZiByb3V0ZS5tYXRjaGVzIHBhdGhcclxuXHRcdFx0XHRjb25zb2xlLmxvZyAnbWF0Y2hlcydcclxuXHRcdFx0XHRpZiByb3V0ZS50YXJnZXQgaW5zdGFuY2VvZiBFbGVnYW5jZS5Db250cm9sbGVyXHJcblx0XHRcdFx0XHQjIGRvIHdlIGhhdmUgYSBjdXJyZW50IHJvdXRlP1xyXG5cdFx0XHRcdFx0aWYgQGN1cnJlbnQgaXNudCBudWxsXHJcblx0XHRcdFx0XHRcdGlmIEBjdXJyZW50LnRhcmdldCBpbnN0YW5jZW9mIEVsZWdhbmNlLkNvbnRyb2xsZXJcclxuXHRcdFx0XHRcdFx0XHRpZiBAY3VycmVudC50YXJnZXQgaXNudCByb3V0ZS50YXJnZXRcclxuXHRcdFx0XHRcdFx0XHRcdEBjdXJyZW50LnRhcmdldC5oaWRlKClcclxuXHJcblx0XHRcdFx0XHQjIHNob3cgaXRcclxuXHRcdFx0XHRcdHJvdXRlLnRhcmdldC5pbml0KCkgdW5sZXNzIHJvdXRlLnRhcmdldC5pbml0aWFsaXplZFxyXG5cdFx0XHRcdFx0dmFsdWUgPSByb3V0ZS50YXJnZXQuc2hvdy5hcHBseShyb3V0ZS50YXJnZXQsIHJvdXRlLmV4dHJhY3RQYXJhbWV0ZXJzKHBhdGgpKVxyXG5cclxuXHRcdFx0XHRcdCMgcHVzaCBzdGF0ZT9cclxuXHRcdFx0XHRcdGlmIHB1c2hTdGF0ZVxyXG5cdFx0XHRcdFx0XHR3aW5kb3cuaGlzdG9yeS5wdXNoU3RhdGUgcGF0aCwgcGF0aCwgQHJvb3RVUkwgKyBwYXRoXHJcblxyXG5cdFx0XHRcdFx0QGN1cnJlbnRVUkkgPSBwYXRoXHJcblx0XHRcdFx0XHRyZXR1cm4gQGN1cnJlbnQgPSByb3V0ZVxyXG5cclxuXHRcdGNvbnNvbGUubG9nIFwiNDA0IE5vdCBGb3VuZCAoI3twYXRofSlcIlxyXG5cclxuXHJcblx0bWFwOiAoY2FsbGJhY2spIC0+XHJcblx0XHRjYWxsYmFjay5hcHBseSh0aGlzKVxyXG5cdFx0Y29uc29sZS5sb2cgJ19fX19fX19fX19yb3V0ZXNfX19fX19fX19fXydcclxuXHRcdGZvciByb3V0ZSBpbiBAcm91dGVzXHJcblx0XHRcdGlmIHJvdXRlLnRhcmdldCBpbnN0YW5jZW9mIEVsZWdhbmNlLkNvbnRyb2xsZXJcclxuXHRcdFx0XHR0YXJnZXQgPSByb3V0ZS50YXJnZXQuY29uc3RydWN0b3IubmFtZVxyXG5cdFx0XHRlbHNlIHRhcmdldCA9IG51bGxcclxuXHRcdFx0Y29uc29sZS5sb2cgXCInI3tyb3V0ZS5wYXRofScgLT4gI3tyb3V0ZS5uYW1lfSAodGFyZ2V0OiAje3RhcmdldH0pXCJcclxuXHRcdGNvbnNvbGUubG9nICctLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0nXHJcblxyXG5cdHJlc291cmNlOiAobmFtZSwgcGF0aCwgdGFyZ2V0ID0gbnVsbCkgLT5cclxuXHRcdEByb3V0ZXMucHVzaCBuZXcgRWxlZ2FuY2UuUm91dGVyLlJvdXRlKEBhcHAsIG5hbWUsIHBhdGgsIHRhcmdldClcclxuXHJcblx0aW5pdDogKCkgLT5cclxuXHRcdHBhdGggPSB3aW5kb3cubG9jYXRpb24uaHJlZi5yZXBsYWNlIEByb290VVJMLCAnJ1xyXG5cdFx0QG5hdmlnYXRlIHBhdGgsIGZhbHNlXHJcblxyXG5cdFx0JCh3aW5kb3cpLmJpbmQgJ3BvcHN0YXRlJywgKGUpID0+XHJcblx0XHRcdHBhdGggPSBlLm9yaWdpbmFsRXZlbnQuc3RhdGVcclxuXHRcdFx0QG5hdmlnYXRlIHBhdGgsIGZhbHNlXHJcblxyXG5cclxuIyByZWdpc3RlciBhcyBhIG1vZHVsZVxyXG5FbGVnYW5jZS5yZWdpc3Rlck1vZHVsZSAncm91dGVyJywgRWxlZ2FuY2UuUm91dGVyIl19